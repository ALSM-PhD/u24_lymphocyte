# Lymphocyte Classification Pipeline
This folder contains all you need for lymphocyte classification and visualizing the results:
1. Ground truth annotation: Put whole slide images into camicroscope, and make it ready for lymphocyte annotation.
2. Training patch extraction: Read annotation from camicroscope and extract annotated patches.
3. Neural network training.
4. Extract all patches in WSIs.
5. Run trained Convolutional Neural Network (CNN) model on extracted patches.
6. Generating and visualizing lymphocyte heatmaps in WSIs.
7. Download lymphocyte heatmaps and compute lymphocyte infiltration rate.

If you have a trained CNN model and you want to generate and visualize lymphocyte heatmaps of some WSIs in camicroscope, just run the following script:

bash svs2heatmap.sh

This basically runs step 4, 5, 6 in sequence.

## Ground truth annotation setup (not fully tested)
Run the following script:

cd camic_setup

bash start.sh

It performs the following operations:
1. copy_svs_to_camic.sh: Copy WSIs to camicroscope.
2. put_meta_data_in.sh: Put meta data of WSIs to the MongoDB of camicroscope. (assumes the database with indices has already been created)
3. touch_humanmark.sh: Create empty lymphocyte heatmaps for each slide. (not implemented yet)

## Training patch extraction (not fully tested)
Run the following script:

cd get_ground_truth

bash start_get_labeled_patches.sh

It performs the following operations:
1. get_raw_human_annotations.sh: Query the MongoDB and save lines drew by human.
2. get_annotation_map.sh: Get lymphocyte heatmap based on human drawings.
3. extract_patches_from_annotation_maps.sh: Extract annotated patches.

## Neural network training
Run the following script to train the Convolutional Autoencoder (CAE):

cd training

bash start_cae_training.sh

It requires unannotated training patches in /data03/shared/lehhou/lym_project/data/vals/ (need to make the dataset downloadable)

Run the following script to train the Convolutional Neural Network (CNN):

cd training

bash start_cnn_training.sh

It requires a trained CAE model (a default one included), and annotated training patches in /data03/shared/lehhou/lym_project/data/vals/ (need to make the dataset downloadable and be able to use patches extracted by start_get_labeled_patches.sh)

Necrosis training code is being organized.

## Extract all patches in WSIs
Run the following script:

cd patch_extraction

bash start.sh

It starts four threads that breaks WSIs down to png tiles in 20X.

## Run trained Convolutional Neural Network (CNN) model on extracted patches.
Run the following script:

cd prediction

bash start.sh

It starts four threads that take extracted patches generated by patch_extraction/start.sh. One thread on GPU0 to predict lymphocytes, one thread on GPU1 to predict necrosis, two CPU threads to segment tissue apart from background.

## Generating and visualizing lymphocyte heatmaps in WSIs (not fully tested)
Run the following script:

cd heatmap_gen

bash start.sh

It takes the output generated by prediction/start.sh as input. It produces low-resolution and high-resolution heatmaps in json files and put those files to MongoDB.

## Download lymphocyte heatmaps and compute lymphocyte infiltration rate (not organized to a script yet)


